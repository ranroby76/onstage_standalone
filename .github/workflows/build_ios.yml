name: Build iOS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build_ios:
    name: Build OnStage (iOS)
    runs-on: macos-latest

    steps:
    # 1. Checkout Code
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    # 2. Install CMake & Ninia (Standard tools)
    - name: Install Tools
      run: |
        brew update
        brew install cmake ninja xcbeautify

    # 3. Download JUCE
    - name: Download JUCE
      run: |
        rm -rf JUCE
        git clone --depth 1 --branch master https://github.com/juce-framework/JUCE.git

    # 4. Configure CMake for iOS
    # We use the Xcode generator (-G Xcode) which is standard for iOS builds
    - name: Configure CMake
      run: |
        cmake -B build -G Xcode \
          -DCMAKE_SYSTEM_NAME=iOS \
          -DCMAKE_OSX_DEPLOYMENT_TARGET=15.0 \
          -DCMAKE_XCODE_ATTRIBUTE_DEVELOPMENT_TEAM="" \
          -DCMAKE_XCODE_ATTRIBUTE_CODE_SIGN_IDENTITY="" \
          -DCMAKE_XCODE_ATTRIBUTE_CODE_SIGNING_REQUIRED="NO" \
          -DCMAKE_XCODE_ATTRIBUTE_CODE_SIGNING_ALLOWED="NO"

    # 5. Build
    - name: Build App
      run: |
        cmake --build build --config Release | xcbeautify

    # 6. Package (Create .ipa payload structure)
    - name: Package IPA
      run: |
        cd build/Release-iphoneos
        mkdir Payload
        mv OnStage.app Payload/
        zip -r OnStage_iOS.ipa Payload
        mv OnStage_iOS.ipa ../../OnStage_iOS.ipa

    # 7. Upload Artifact
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: OnStage_iOS_App
        path: OnStage_iOS.ipa