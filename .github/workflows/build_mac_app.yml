name: Build macOS App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build_mac_app:
    name: Build macOS Standalone
    runs-on: macos-14

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Clone JUCE Framework
        run: |
          git clone --depth 1 --branch master https://github.com/juce-framework/JUCE.git JUCE

      - name: Import Signing Certificate
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.MACOS_CERTIFICATE }}
          P12_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: "admin"
        run: |
          # Skip signing if secrets aren't configured yet
          if [ -z "$BUILD_CERTIFICATE_BASE64" ]; then
            echo "::warning::No signing certificate configured — skipping code signing"
            echo "SKIP_SIGNING=true" >> $GITHUB_ENV
            exit 0
          fi

          echo $BUILD_CERTIFICATE_BASE64 | base64 --decode > certificate.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security import certificate.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/productsign
          security set-key-partition-list -S apple-tool:,apple:,codesign:,productsign: -s -k "$KEYCHAIN_PASSWORD" build.keychain

          echo "Available signing identities:"
          security find-identity -v -p codesigning build.keychain
          echo "SKIP_SIGNING=false" >> $GITHUB_ENV

      # Xcode generator — proven for macOS universal builds
      - name: Configure CMake
        run: |
          cmake -B build -G Xcode \
            -DJUCE_DIR="${{ github.workspace }}/JUCE" \
            -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15

      - name: Build App
        run: cmake --build build --config Release --parallel $(sysctl -n hw.logicalcpu)

      - name: Create Entitlements
        run: |
          cat > entitlements.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>com.apple.security.device.audio-input</key>
              <true/>
              <key>com.apple.security.cs.disable-library-validation</key>
              <true/>
          </dict>
          </plist>
          EOF

      - name: Sign & Notarize
        if: env.SKIP_SIGNING != 'true'
        env:
          APPLE_ID: ${{ secrets.MACOS_NOTARIZATION_USERNAME }}
          APPLE_PASSWORD: ${{ secrets.MACOS_NOTARIZATION_PASSWORD }}
          TEAM_ID: ${{ secrets.MACOS_NOTARIZATION_TEAM_ID }}
          KEYCHAIN_PASSWORD: "admin"
        run: |
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security list-keychains -d user -s build.keychain

          IDENTITY=$(security find-identity -v -p codesigning build.keychain | grep "Developer ID Application" | head -1 | grep -o '"[^"]*"' | sed 's/"//g')

          if [ -z "$IDENTITY" ]; then
            echo "::error::No Developer ID Application certificate found"
            security find-identity -v -p codesigning build.keychain
            exit 1
          fi

          echo "Signing with identity: $IDENTITY"

          APP_PATH=$(find build -name "OnStage.app" -type d | head -1)

          if [ -z "$APP_PATH" ]; then
            echo "::error::OnStage.app not found!"
            find build -name "*.app" -type d
            exit 1
          fi

          echo "Processing $APP_PATH..."

          # Sign inner dylibs/frameworks first (inside-out)
          find "$APP_PATH" -type f \( -name "*.dylib" -o -name "*.so" \) \
            -exec codesign --force --options runtime --sign "$IDENTITY" --timestamp {} \;

          find "$APP_PATH" -type d -name "*.framework" \
            -exec codesign --force --options runtime --sign "$IDENTITY" --timestamp {} \;

          # Sign the app bundle
          codesign --force --deep --strict \
            --options runtime \
            --sign "$IDENTITY" \
            --entitlements entitlements.plist \
            --timestamp \
            "$APP_PATH"

          codesign --verify --deep --strict --verbose=2 "$APP_PATH"

          /usr/bin/ditto -c -k --keepParent "$APP_PATH" "OnStage_Mac_Submission.zip"

          echo "Submitting for notarization..."
          xcrun notarytool submit "OnStage_Mac_Submission.zip" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_PASSWORD" \
            --team-id "$TEAM_ID" \
            --wait

          xcrun stapler staple "$APP_PATH"

      - name: Package App
        run: |
          APP_PATH=$(find build -name "OnStage.app" -type d | head -1)
          /usr/bin/ditto -c -k --keepParent "$APP_PATH" "OnStage_Mac.zip"

      - name: Upload App
        uses: actions/upload-artifact@v4
        with:
          name: OnStage-Mac-App
          path: OnStage_Mac.zip
