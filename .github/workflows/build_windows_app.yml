name: Build Windows App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build_windows_app:
    name: Build Windows Standalone
    runs-on: windows-2022

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          lfs: true

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Clone JUCE Framework
        shell: pwsh
        run: |
          if (Test-Path JUCE) { Remove-Item -Recurse -Force JUCE }
          git clone --depth 1 --branch master https://github.com/juce-framework/JUCE.git JUCE

      - name: Setup VLC SDK
        shell: pwsh
        run: |
          $vlcUrl = "https://get.videolan.org/vlc/3.0.21/win64/vlc-3.0.21-win64.7z"
          $outputFile = "vlc.7z"

          Write-Host "Downloading VLC from $vlcUrl..."
          Invoke-WebRequest -Uri $vlcUrl -OutFile $outputFile

          Write-Host "Extracting VLC..."
          7z x $outputFile -y

          if (Test-Path "vlc-3.0.21-win64") {
            Rename-Item "vlc-3.0.21-win64" "vlc-3.0.21"
          }

          if (Test-Path "vlc-3.0.21/sdk/lib/libvlc.lib") {
            Write-Host "VLC SDK found and ready."
          } else {
            Write-Error "VLC SDK not found in extracted folder!"
            exit 1
          }

      - name: Configure CMake
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A x64 `
            -DJUCE_DIR="${{ github.workspace }}/JUCE" `
            -DVLC_ROOT="${{ github.workspace }}/vlc-3.0.21"

      - name: Build App
        run: cmake --build build --config Release --parallel 4

      - name: Package App
        shell: pwsh
        run: |
          $distDir = "dist_windows"
          $zipName = "OnStage_Windows.zip"

          New-Item -ItemType Directory -Force -Path $distDir

          $exePath = Get-ChildItem -Path build -Recurse -Filter "OnStage.exe" | Select-Object -First 1

          if ($null -eq $exePath) {
            Write-Error "OnStage.exe NOT FOUND!"
            Get-ChildItem -Path build -Recurse -Filter "*.exe" | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }

          Write-Host "Found: $($exePath.FullName)"
          Copy-Item $exePath.FullName -Destination $distDir

          Copy-Item "vlc-3.0.21/libvlc.dll" -Destination $distDir
          Copy-Item "vlc-3.0.21/libvlccore.dll" -Destination $distDir
          Copy-Item -Recurse "vlc-3.0.21/plugins" -Destination "$distDir/plugins"

          Compress-Archive -Path "$distDir/*" -DestinationPath $zipName

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OnStage-Windows-App
          path: OnStage_Windows.zip
