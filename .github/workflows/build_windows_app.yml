name: Build Windows App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build_windows_app:
    name: Build Windows Standalone
    runs-on: windows-2022
    
    steps:
      # 1. Checkout
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          lfs: true

      # 2. Setup Compiler
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      # 3. Clone JUCE
      - name: Clone JUCE Framework
        run: |
          git clone --depth 1 --branch master https://github.com/juce-framework/JUCE.git JUCE

      # 4. Setup VLC SDK (Required for Windows Build)
      - name: Setup VLC SDK
        shell: pwsh
        run: |
          $vlcUrl = "https://get.videolan.org/vlc/3.0.21/win64/vlc-3.0.21-win64.7z"
          $outputFile = "vlc.7z"
          
          Write-Host "Downloading VLC from $vlcUrl..."
          Invoke-WebRequest -Uri $vlcUrl -OutFile $outputFile
          
          Write-Host "Extracting VLC..."
          7z x $outputFile -y
          
          # Rename folder to match CMake expectation "vlc-3.0.21"
          if (Test-Path "vlc-3.0.21-win64") {
            Rename-Item "vlc-3.0.21-win64" "vlc-3.0.21"
          }
          
          if (Test-Path "vlc-3.0.21/sdk/lib/libvlc.lib") {
            Write-Host "VLC SDK found and ready."
          } else {
            Write-Error "VLC SDK not found in extracted folder!"
            exit 1
          }

      # 5. Configure CMake
      - name: Configure CMake
        run: |
          # JUCE_ASIO=1 is required for your OnStage ASIO features
          cmake -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DJUCE_ASIO=1

      # 6. Build
      - name: Build App
        run: cmake --build build --config Release --parallel 4

      # 7. Collect & Zip Artifacts
      - name: Package App
        shell: pwsh
        run: |
          $buildDir = "build/Release"
          $distDir = "dist_windows"
          $zipName = "OnStage_Windows.zip"
          
          New-Item -ItemType Directory -Force -Path $distDir
          
          # Check for Executable
          if (Test-Path "$buildDir/OnStage.exe") {
            Write-Host "Found OnStage.exe, copying..."
            Copy-Item "$buildDir/OnStage.exe" -Destination $distDir
            
            # Copy VLC DLLs required for runtime
            # These must sit next to the .exe for it to launch
            Copy-Item "vlc-3.0.21/libvlc.dll" -Destination $distDir
            Copy-Item "vlc-3.0.21/libvlccore.dll" -Destination $distDir
            Copy-Item -Recurse "vlc-3.0.21/plugins" -Destination "$distDir/plugins"
            
            # Copy Assets (if CMake copies them to build dir, otherwise from source)
            if (Test-Path "$buildDir/assets") {
                Copy-Item -Recurse "$buildDir/assets" -Destination "$distDir/assets"
            }
          } else {
            Write-Error "OnStage.exe NOT FOUND in build directory!"
            exit 1
          }
          
          # Create Zip
          Compress-Archive -Path "$distDir/*" -DestinationPath $zipName

      # 8. Upload
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OnStage-Windows-App
          path: OnStage_Windows.zip